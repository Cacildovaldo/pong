<!DOCTYPE html>
<html lang="en">
<head>
  <!-- (Manter todo o cabeçalho existente até a linha 134) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <style>
    /* (Adicionar estilos novos no final da tag style, antes do </head>) */
    .game-container {
      position: relative;
      margin: 20px auto;
    }
    .score-display {
      display: flex;
      justify-content: space-between;
      width: 400px;
      margin: 0 auto;
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      color: #00bcd4;
    }
    .game-status {
      margin: 10px 0;
      font-size: 18px;
      color: #00bcd4;
    }
    #gameCanvas {
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      background: #0a0a1a;
      display: none; /* Inicialmente oculto */
      margin: 0 auto;
    }
    .player-info {
      background: rgba(10, 10, 26, 0.7);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
<!-- (Manter todo o corpo existente até a seção de compartilhamento) -->

<!-- Adicionar esta seção antes do share-section -->
<div id="realGameSection" class="hidden">
  <div class="game-container">
    <div class="score-display">
      <span id="player1Score">0</span>
      <span id="player2Score">0</span>
    </div>
    <div class="game-status" id="gameStatus">Waiting for opponent...</div>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
  </div>
  <div class="player-info">
    <p>You are: <span id="playerPosition">-</span></p>
    <p>Opponent: <span id="opponentAddress">-</span></p>
    <p>Bet Amount: <span id="currentBet">0</span> USDC</p>
  </div>
  <button id="leaveGameBtn" onclick="leaveGame()">Leave Game</button>
</div>

<!-- (Manter o restante do corpo existente) -->

<script>
// Configurações atualizadas
let provider, signer, contract, isConnected = false;
let socket;
let currentGame = null;
let playerAddress = null;
let playerNumber = null;
let gameInterval = null;

// Contrato atualizado
const CONTRACT_ADDRESS = "0x7228FC125EF5b4598315CEc74c37C16Fb2100447";
const CONTRACT_ABI = [
  {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"USDC","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositBet","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"opponent","type":"address"}],"name":"challengePlayer","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"loser","type":"address"}],"name":"declareWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawBet","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"getWaitingPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"player","type":"address"}],"name":"getGame","outputs":[{"components":[{"internalType":"address","name":"player1","type":"address"},{"internalType":"address","name":"player2","type":"address"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"},{"internalType":"bool","name":"gameEnded","type":"bool"},{"internalType":"address","name":"winner","type":"address"}],"internalType":"struct PongBetGame.Game","name":"","type":"tuple"}],"stateMutability":"view","type":"function"}
];

// URL do servidor Socket.io (você vai substituir pelo seu depois)
const SOCKET_SERVER_URL = "https://pong-game-server.onrender.com";

// Inicializar Socket.io
function initSocket() {
  socket = io(SOCKET_SERVER_URL, {
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 1000
  });

  socket.on('connect', () => {
    console.log('Connected to game server');
    if (playerAddress) {
      socket.emit('register', playerAddress);
    }
  });

  socket.on('game_start', (data) => {
    startGame(data.player1, data.player2, data.betAmount);
  });

  socket.on('game_state', (state) => {
    updateGameState(state);
  });

  socket.on('game_over', (winner) => {
    endGame(winner);
  });
}

// Funções do jogo (adicionar após as funções existentes)
function startGame(player1, player2, betAmount) {
  currentGame = { player1, player2, betAmount };
  playerNumber = playerAddress.toLowerCase() === player1.toLowerCase() ? 1 : 2;
  
  // Esconder demonstração e mostrar jogo real
  document.getElementById('demoCanvas').style.display = 'none';
  document.getElementById('playSection').classList.add('hidden');
  document.getElementById('realGameSection').classList.remove('hidden');
  
  document.getElementById('playerPosition').textContent = playerNumber === 1 ? 'Left' : 'Right';
  document.getElementById('opponentAddress').textContent = playerNumber === 1 ? 
    shortenAddress(player2) : shortenAddress(player1);
  document.getElementById('currentBet').textContent = (betAmount / 1000000).toFixed(0);
  
  // Iniciar canvas do jogo
  const canvas = document.getElementById('gameCanvas');
  canvas.style.display = 'block';
  canvas.addEventListener('mousemove', handlePaddleMove);
  
  // Notificar servidor que estamos prontos
  socket.emit('player_ready', { gameId: `${player1}-${player2}` });
}

function updateGameState(state) {
  // Atualizar placar
  document.getElementById('player1Score').textContent = state.score1;
  document.getElementById('player2Score').textContent = state.score2;
  
  // Desenhar estado do jogo
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  
  ctx.fillStyle = '#0a0a1a';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Desenhar linha central
  ctx.strokeStyle = 'rgba(0, 188, 212, 0.3)';
  ctx.setLineDash([5, 10]);
  ctx.beginPath();
  ctx.moveTo(canvas.width/2, 0);
  ctx.lineTo(canvas.width/2, canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Desenhar bola
  ctx.fillStyle = '#00bcd4';
  ctx.beginPath();
  ctx.arc(state.ball.x, state.ball.y, state.ball.r, 0, Math.PI * 2);
  ctx.fill();
  
  // Desenhar raquetes
  ctx.fillStyle = playerNumber === 1 ? '#4CAF50' : '#00bcd4';
  ctx.fillRect(20, state.paddle1.y, 10, state.paddle1.height);
  
  ctx.fillStyle = playerNumber === 2 ? '#4CAF50' : '#00bcd4';
  ctx.fillRect(canvas.width - 30, state.paddle2.y, 10, state.paddle2.height);
}

function handlePaddleMove(e) {
  if (!currentGame || !playerNumber) return;
  
  const canvas = document.getElementById('gameCanvas');
  const rect = canvas.getBoundingClientRect();
  const y = e.clientY - rect.top;
  
  socket.emit('player_move', {
    gameId: `${currentGame.player1}-${currentGame.player2}`,
    yPosition: y
  });
}

function endGame(winner) {
  const isWinner = winner.toLowerCase() === playerAddress.toLowerCase();
  const statusEl = document.getElementById('gameStatus');
  
  if (isWinner) {
    statusEl.textContent = 'You won! Prize will be distributed automatically.';
    statusEl.style.color = '#4CAF50';
  } else {
    statusEl.textContent = 'You lost. Better luck next time!';
    statusEl.style.color = '#f44336';
  }
  
  setTimeout(() => {
    leaveGame();
  }, 5000);
}

function leaveGame() {
  if (currentGame) {
    socket.emit('leave_game', { gameId: `${currentGame.player1}-${currentGame.player2}` });
    currentGame = null;
  }
  
  document.getElementById('realGameSection').classList.add('hidden');
  document.getElementById('playSection').classList.remove('hidden');
  document.getElementById('demoCanvas').style.display = 'block';
  document.getElementById('gameCanvas').style.display = 'none';
}

// Atualizar connectWallet para incluir initSocket
async function connectWallet() {
  try {
    // ... (código existente)
    
    playerAddress = await signer.getAddress();
    initSocket(); // Adicionar esta linha
    
    // ... (restante do código existente)
  } catch (error) {
    console.error("Error connecting wallet:", error);
    alert("Error connecting wallet: " + error.message);
  }
}

// Função auxiliar para encurtar endereços
function shortenAddress(address) {
  return `${address.substring(0, 6)}...${address.substring(38)}`;
}

// (Manter todas as outras funções existentes)
</script>
</body>
</html>
