<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Todo o cabeçalho original...] -->
  <!-- Adicione APENAS esta linha no <head>: -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
  <!-- [Todo o corpo original...] -->

  <!-- Adicione APENAS esta seção antes do share-section -->
  <div id="realGameSection" class="hidden">
    <div class="game-container">
      <div class="score-display">
        <span id="player1Score">0</span>
        <span id="player2Score">0</span>
      </div>
      <div class="game-status" id="gameStatus">Waiting for opponent...</div>
      <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>
    <div class="player-info">
      <p>You are: <span id="playerPosition">-</span></p>
      <p>Opponent: <span id="opponentAddress">-</span></p>
      <p>Bet Amount: <span id="currentBet">0</span> USDC</p>
    </div>
    <button id="leaveGameBtn" onclick="leaveGame()">Leave Game</button>
  </div>

  <!-- [Restante do corpo original...] -->

  <script>
  // Adicione APENAS estas variáveis no início do <script>:
  let socket;
  let currentGame = null;
  let playerNumber = null;
  const SOCKET_SERVER_URL = "https://pong-server-9007.onrender.com";

  // Adicione APENAS estas funções NO FINAL do <script> (antes do demoGame()):
  function initSocket() {
    socket = io(SOCKET_SERVER_URL);
    socket.on('game_start', (data) => startGame(data.player1, data.player2, data.betAmount));
    socket.on('game_state', updateGameState);
    socket.on('game_over', endGame);
  }

  function startGame(p1, p2, betAmount) {
    currentGame = { player1: p1, player2: p2, betAmount };
    playerNumber = playerAddress.toLowerCase() === p1.toLowerCase() ? 1 : 2;
    
    document.getElementById('demoCanvas').style.display = 'none';
    document.getElementById('playSection').classList.add('hidden');
    document.getElementById('realGameSection').classList.remove('hidden');
    
    document.getElementById('playerPosition').textContent = playerNumber === 1 ? 'Left' : 'Right';
    document.getElementById('opponentAddress').textContent = playerNumber === 1 ? 
      `${p2.substring(0, 6)}...${p2.substring(38)}` : `${p1.substring(0, 6)}...${p1.substring(38)}`;
    document.getElementById('currentBet').textContent = (betAmount / 1000000).toFixed(0);
    
    const canvas = document.getElementById('gameCanvas');
    canvas.style.display = 'block';
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const y = e.clientY - rect.top;
      socket.emit('player_move', { gameId: `${p1}-${p2}`, yPosition: y });
    });
  }

  function updateGameState(state) {
    document.getElementById('player1Score').textContent = state.score1;
    document.getElementById('player2Score').textContent = state.score2;
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = '#00bcd4';
    ctx.beginPath();
    ctx.arc(state.ball.x, state.ball.y, state.ball.r, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = playerNumber === 1 ? '#4CAF50' : '#00bcd4';
    ctx.fillRect(20, state.paddle1.y, 10, 60);
    ctx.fillStyle = playerNumber === 2 ? '#4CAF50' : '#00bcd4';
    ctx.fillRect(370, state.paddle2.y, 10, 60);
  }

  function endGame(winner) {
    const isWinner = winner.toLowerCase() === playerAddress.toLowerCase();
    document.getElementById('gameStatus').textContent = isWinner ? 'You won!' : 'You lost!';
    setTimeout(leaveGame, 3000);
  }

  function leaveGame() {
    document.getElementById('realGameSection').classList.add('hidden');
    document.getElementById('playSection').classList.remove('hidden');
    document.getElementById('demoCanvas').style.display = 'block';
  }

  // Modifique a função connectWallet() para incluir isto no final:
  async function connectWallet() {
    // [Código original...]
    playerAddress = await signer.getAddress();
    initSocket(); // Adicione esta linha
  }
  </script>
</body>
</html>
